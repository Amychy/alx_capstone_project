<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizWiz - Test Your Knowledge</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/logo.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.15/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
    {% include "header.html" %}
    <div id="timer" class="timer font-semibold text-base my-5 text-center uppercase"></div>
    
    <main class="flex items-center justify-center my-10 md:my-14 mx-auto">
        <div class="relative">
            <img class="max-w-xs md:max-w-xl" src="{{ url_for('static', filename='images/Group 3.png') }}">
            <div class="absolute top-0 left-0 right-0 bottom-0 my-0 mx-auto flex flex-col justify-center items-center pb-0 pt-0 px-20 md:p-10 w-full md:w-96">
                <div id="quiz-container" class="uppercase black font-bold text-base text-center">
                    <h1 class="text-xs md:text-lg question" id="question-placeholder"></h1>
                    <div class="mt-2 text-xs md:text-base options" id="options-container">
                        <!-- Options for the currently displayed question will be inserted here -->
                    </div>
                    <button id="next-button" class="header-btn-bg text-white md:py-3 py-2 px-3 md:px-5 rounded-xl text-sm md:text-lg font-medium mt-4">Next</button>
                </div>
                                
            </div>
        </div>
        <div id="modal" class="modal" style="display: none;">
            <div class="modal-content p-4 rounded-lg w-11/12 md:w-5/12">
                <h2 id="modal-header"></h2>
                <p id="modal-message" class="flex flex-col items-center justify-center"></p>
                <p id="modal-score"></p>
                <button class="header-btn-bg text-white md:py-3 py-2 px-3 md:px-5 rounded-xl text-sm md:text-lg font-medium mt-4">Next</button>
            </div>
        </div>
        
    </main>

    {% include "footer.html" %}


    <script src="../static/js/hamburger.js"></script>
    <script>
         let timer;
        let timeLeft = 50; // Set the timer duration to 50 seconds
        let currentScore = 0;
        let totalScore = 0;
let currentQuestionIndex = 0;
let numberOfQuestions;  // Store the total number of questions
let scores = [];  // Store individual scores
    
        // Flag to track whether the quiz is running or not
        let quizRunning = true;
        function restartQuiz() {
    // Reload the page to reset everything
    location.reload();
}

    
        function openModal(header, message, score, isSuccess, isTimeout) {
            const modal = document.getElementById('modal');
            modal.style.display = 'block';
            document.getElementById('modal-header').textContent = header;
    
            const nextButton = document.querySelector('#modal button');
            if (isTimeout) {
                // If it's a timeout, end the quiz
                nextButton.addEventListener('click', function() {
                    clearInterval(timer);
                    closeModal();
                    displayQuizCompletion();
                });
            } else {
                nextButton.addEventListener('click', closeModal);
            }
    
            const modalMessage = document.getElementById('modal-message');
            modalMessage.textContent = message;
    
            if (isSuccess) {
                modalMessage.style.color = '#069414';
                modalMessage.style.fontSize = '24px';
                modalMessage.innerHTML += '<img src="../static/images/success.png" alt="Success">';
            } else {
                modalMessage.style.color = '#B90F05';
                modalMessage.style.fontSize = '20px';
                modalMessage.innerHTML += '<img class="w-20" src="../static/images/error.png" alt="Error">';
            }
    
            document.getElementById('modal-score').textContent = `Your score: ${score}`;
        }
    
        function closeModal() {
            const modal = document.getElementById('modal');
            modal.style.display = 'none';
        }
    
        function displayQuizCompletion() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = '';
    
            const completionMessage = document.createElement('div');
            completionMessage.innerHTML = `
                <h1>Quiz Completed</h1>
                <p>Total Score = ${currentScore}</p>
                <div class="flex justify-between items-center gap-5">
                    <button class="header-btn-bg text-white md:py-3 py-px px-px md:px-5 rounded-xl text-sm md:text-lg font-medium mt-4" onclick="restartQuiz()">Restart Quiz</button>
                    <button class="header-btn-bg text-white md:py-3 py-px px-px md:px-5 rounded-xl text-sm md:text-lg font-medium mt-4" onclick="location.href='/';">Retake Quiz</button>
                </div>
            `;
    
            quizContainer.appendChild(completionMessage);
        }

        function recordScore(score, category) {
    fetch('/submit_score', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ score: score, category: category }), 
    })
    .then(response => response.json())
    .then(data => {
        console.log('Score recorded:', data);
    })
    .catch(error => {
        console.error('Error recording score:', error);
    });
}

    
        function fetchQuestions(selectedCategory) {
            console.log(`Fetching questions for category: ${selectedCategory}`);
            fetch(`/api/questions?category=${selectedCategory}`)
                .then(response => response.json())
                .then(data => {
                    numberOfQuestions = data.questions.length; // Store the total number of questions
                    console.log('Data received:', data);
                    const questionElement = document.getElementById('question-placeholder');
                    const optionsContainer = document.getElementById('options-container');
                    const nextButton = document.getElementById('next-button');
                    let currentQuestionIndex = 0;
                    const totalQuestions = data.questions.length;
                    const correctAnswers = data.questions.map(question => question.correct_option);
    
                    function displayQuestion(questionIndex) {
                        if (!quizRunning) {
                            return; // Don't proceed if the quiz is not running
                        }
                        const currentQuestion = data.questions[questionIndex];
                        console.log(`Displaying question ${questionIndex + 1} of ${totalQuestions}`);
                        questionElement.textContent = currentQuestion.question;
                        optionsContainer.innerHTML = '';
                        const options = [
                            currentQuestion.option_a,
                            currentQuestion.option_b,
                            currentQuestion.option_c,
                            currentQuestion.option_d
                        ];
    
                        options.forEach((option, index) => {
                            const optionLabel = document.createElement('label');
                            optionLabel.classList.add('flex', 'flex-row', 'gap-6', 'font-medium', 'option-label');
                            optionLabel.innerHTML = `
                                <input type="radio" value="${String.fromCharCode(65 + index)}" name="answer" class="mt-1"> ${String.fromCharCode(65 + index)}. ${option}
                            `;
                            optionsContainer.appendChild(optionLabel);
                        });
    
                        nextButton.addEventListener('click', () => {
    if (!quizRunning) {
        return; // Don't proceed if the quiz is not running
    }
    const selectedAnswer = document.querySelector('input[name="answer"]:checked');
    if (selectedAnswer) {
        const answerValue = selectedAnswer.value;
        if (answerValue === correctAnswers[questionIndex]) {
            currentScore++;
            openModal('Success!', 'You answered the question correctly!', currentScore, true, false);
        } else {
            openModal('Incorrect', 'Your answer is incorrect.', currentScore, false, false);
        }
        selectedAnswer.checked = false;

        if (questionIndex < totalQuestions - 1) {
            questionIndex++;
            displayQuestion(questionIndex);
        } else {
            quizRunning = false; // Mark the quiz as completed
            displayQuizCompletion();
            clearInterval(timer);

            // Store the current score in the array of scores
            scores.push(currentScore);

            if (scores.length === numberOfQuestions) {
                // Calculate the total score
                totalScore = scores.reduce((acc, cur) => acc + cur, 0);

                // Send the total score to the server
                recordScore(totalScore, selectedCategory);
            } else {
                // If all questions have been answered, but scores are not yet sent (e.g., if the quiz is aborted)
                // Send the current score
                recordScore(currentScore, selectedCategory);
            }
        }
    }
});

                        // Start the timer for each question
                        startTimer(selectedCategory);
                    }
    
                    displayQuestion(currentQuestionIndex);
                })
                .catch(error => {
                    console.error('Error fetching questions:', error);
                });
        }
    
        function startTimer(selectedCategory) {
    if (!quizRunning) {
        return; // Don't proceed if the quiz is not running
    }
    console.log("Start timer");
    updateTimerDisplay();

    clearInterval(timer);
    timer = setInterval(function () {
        if (timeLeft > 0) {
            timeLeft--;
            updateTimerDisplay();
        } else {
            quizRunning = false; // Mark the quiz as completed
            clearInterval(timer);
            openModal("Time's Up!", "You ran out of time for this question.", currentScore, false, true);
             // Store the current score in the array of scores
            scores.push(currentScore);

if (scores.length === numberOfQuestions) {
    // Calculate the total score
    totalScore = scores.reduce((acc, cur) => acc + cur, 0);

    // Send the total score to the server
    recordScore(totalScore, selectedCategory);
} else {
    // If all questions have been answered, but scores are not yet sent (e.g., if the quiz is aborted)
    // Send the current score
    recordScore(currentScore, selectedCategory);
}
}
}, 1000);
}
    
        function updateTimerDisplay() {
            const timerElement = document.getElementById('timer');
            timerElement.textContent = `Time Left: ${timeLeft} seconds`;
        }
    
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const selectedCategory = urlParams.get('category');
    
            console.log(`Selected category from URL: ${selectedCategory}`);
    
            if (selectedCategory) {
                fetchQuestions(selectedCategory);
            } else {
                console.error('No category selected.');
            }
        });
    </script>  

</body>
</html>
